<!DOCTYPE html>
<html lang="es">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
Â  Â  <title>Racing Arcade</title>
Â  Â Â 
Â  Â  <link rel="manifest" href="manifest.json">
Â  Â  <meta name="theme-color" content="#2c3e50">

Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --accent: #f1c40f;
Â  Â  Â  Â  Â  Â  --bg-glass: rgba(0, 0, 0, 0.85);
Â  Â  Â  Â  Â  Â  --border-glass: rgba(255, 255, 255, 0.1);
Â  Â  Â  Â  Â  Â  --weekly-clr: #9b59b6;
Â  Â  Â  Â  }
Â  Â  Â  Â  body { margin: 0; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: white; }
Â  Â  Â  Â  #game-container { position: fixed; inset: 0; background: #2c3e50; overflow: hidden; display: flex; justify-content: center; align-items: center; }
Â  Â  Â  Â  canvas { width: 100vw; height: 100vh; display: block; image-rendering: pixelated; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #toast-container { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); z-index: 200; pointer-events: none; width: 280px; }
Â  Â  Â  Â  .toast { background: var(--bg-glass); border: 1px solid var(--accent); padding: 12px; border-radius: 15px; margin-bottom: 8px; text-align: center; animation: slideIn 0.4s ease-out, fadeOut 0.4s 2.6s forwards; backdrop-filter: blur(10px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
Â  Â  Â  Â  .toast.logro { border-color: var(--weekly-clr); }
Â  Â  Â  Â  .toast b { display: block; color: var(--accent); font-size: 14px; text-transform: uppercase; }
Â  Â  Â  Â  .toast.logro b { color: var(--weekly-clr); }
Â  Â  Â  Â  .toast p { margin: 4px 0 0; font-size: 12px; font-weight: 600; }
Â  Â  Â  Â  @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
Â  Â  Â  Â  @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }

Â  Â  Â  Â  .hud { position: absolute; top: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; box-sizing: border-box; z-index: 10; pointer-events: none; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
Â  Â  Â  Â  .stat { font-size: 18px; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); line-height: 1.3; }
Â  Â  Â  Â  .bar-container { width: 140px; height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); margin-top: 6px; overflow: hidden; }
Â  Â  Â  Â  #fuel-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.3s; }
Â  Â  Â  Â  .fuel-low { animation: pulse-red 0.5s infinite; }
Â  Â  Â  Â  @keyframes pulse-red { 0%, 100% { background: #e74c3c; } 50% { background: #c0392b; opacity: 0.5; } }

Â  Â  Â  Â  #btn-pause-trigger { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 45px; height: 45px; background: var(--bg-glass); border: 2px solid white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; pointer-events: auto; z-index: 20; }
Â  Â  Â  Â  #loading-screen { position: absolute; inset: 0; background: #000 url('Items/fondo_carga.png') no-repeat center center; background-size: contain; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; text-align: center; transition: opacity 0.5s; }
Â  Â  Â  Â  .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; padding: 25px; text-align: center; }
Â  Â  Â  Â  .hidden { display: none !important; opacity: 0; pointer-events: none; }
Â  Â  Â  Â  .loader { width: 200px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px; overflow: hidden; }
Â  Â  Â  Â  .loader-bar { width: 0%; height: 100%; background: var(--accent); animation: load 2.5s forwards; }
Â  Â  Â  Â  @keyframes load { 0% { width: 0%; } 100% { width: 100%; } }
Â  Â  Â  Â  .ui-card { background: var(--bg-glass); border: 1px solid var(--border-glass); padding: 30px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); width: 320px; position: relative; }
Â  Â  Â  Â  h1 { margin: 0 0 20px; font-size: 28px; font-weight: 900; letter-spacing: -1px; text-transform: uppercase; }
Â  Â  Â  Â  button { padding: 16px; font-size: 14px; cursor: pointer; border: none; color: white; border-radius: 15px; font-weight: 800; min-width: 100%; margin: 8px 0; text-transform: uppercase; }
Â  Â  Â  Â  .btn-green { background: #2ecc71; } .btn-blue { background: #3498db; } .btn-orange { background: #e67e22; } .btn-red { background: #e74c3c; }
Â  Â  Â  Â  #timer-display { font-size: 60px; font-weight: 900; color: var(--accent); margin: 10px 0; }
Â  Â  Â  Â  .magnet-active { color: #f1c40f; text-shadow: 0 0 10px #f1c40f; animation: blink 0.5s infinite; }
Â  Â  Â  Â  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
Â  Â  Â  Â  .mission-box { background: rgba(255,255,255,0.05); border: 1px dashed rgba(241,196,15,0.5); padding: 15px; border-radius: 20px; margin: 10px 0; text-align: left; }
Â  Â  Â  Â  #mobile-controls { position: absolute; bottom: 40px; left: 0; width: 100%; display: none; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 50; }
Â  Â  Â  Â  .touch-btn { width: 70px; height: 70px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
Â  Â  Â  Â  .shop-coin-tag { text-align: right; font-size: 14px; color: var(--accent); font-weight: 800; margin-bottom: 10px; margin-top: -10px; }
Â  Â  Â  Â  .ver-tag { position: absolute; top: 15px; left: 20px; font-size: 10px; color: rgba(255,255,255,0.3); font-weight: 800; }
Â  Â  </style>
</head>
<body>

<div id="toast-container"></div>

<div id="loading-screen">
Â  Â  <h1>RACING ARCADE</h1>
Â  Â  <p style="font-size: 12px; color: #bdc3c7;">creado por Blas Borrione</p>
Â  Â  <div class="loader"><div class="loader-bar"></div></div>
</div>

<div id="game-container">
Â  Â  <div id="btn-pause-trigger" onclick="togglePause()">II</div>
Â  Â  <div class="hud">
Â  Â  Â  Â  <div class="stat"><span style="color:#f1c40f; font-size:22px;"><span id="ui-speed">0</span> KM/H</span><br>DIST: <span id="ui-score">0</span>m<br><small>NIVEL: <span id="ui-level">1</span></small></div>
Â  Â  Â  Â  <div class="stat" style="text-align:right"><span id="ui-coin-label">ğŸ’° <span id="ui-coins-total">0</span></span><br><div class="bar-container"><div id="fuel-bar"></div></div>â¤ï¸ <span id="ui-lives-text">3</span></div>
Â  Â  </div>
Â  Â  <div id="mobile-controls">
Â  Â  Â  Â  <div style="display:flex; gap:10px;"><div class="touch-btn" id="t-left">â—€</div><div class="touch-btn" id="t-right">â–¶</div></div>
Â  Â  Â  Â  <div style="display:flex; gap:10px;"><div class="touch-btn" id="t-brake" style="color:#e74c3c">FR</div><div class="touch-btn" id="t-up" style="color:#2ecc71">GAS</div></div>
Â  Â  </div>

Â  Â  <div id="menu" class="overlay hidden">
Â  Â  Â  Â  <div class="ui-card">
Â  Â  Â  Â  Â  Â  <span class="ver-tag">v15.0 (Sound Update)</span>
Â  Â  Â  Â  Â  Â  <h1>RACING ARCADE</h1>
Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-around; font-size:12px; margin-bottom:15px;"><span>RÃ‰CORD: <b id="menu-high-score">0</b>m</span><span>ğŸ’° <b id="menu-total-coins">0</b></span></div>
Â  Â  Â  Â  Â  Â  <div class="mission-box"><small style="color:#f1c40f; font-weight:800;">DIARIA</small><p id="menu-mission-desc" style="margin:2px 0; font-size:12px;"></p></div>
Â  Â  Â  Â  Â  Â  <div class="mission-box" style="border-color: var(--weekly-clr); border-style: solid;"><small style="color:var(--weekly-clr); font-weight:800;">SEMANAL (5.000ğŸ’°)</small><p id="menu-weekly-desc" style="margin:2px 0; font-size:11px;"></p><div class="bar-container" style="width:100%; height:6px; background:rgba(255,255,255,0.05); border:none;"><div id="weekly-bar" style="width:0%; background:var(--weekly-clr); height:100%; border-radius:3px;"></div></div></div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="btn-green" onclick="requestFullScreen(); startGame()">CORRER</button>
Â  Â  Â  Â  Â  Â  <button class="btn-blue" onclick="openShop()">GARAJE</button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="btn-orange" onclick="openRanking()" style="background: #9b59b6;">ğŸ† RÃNKING MUNDIAL</button>
Â  Â  Â  Â  Â  Â  <button id="btn-login" class="btn-blue" style="background: #4285F4; margin-top: 10px;" onclick="loginGoogle()">â˜ï¸ CONECTAR CON GOOGLE</button>
Â  Â  Â  Â  Â  Â  <p id="user-status" style="font-size: 10px; color: #bdc3c7; margin-top: 5px;">No conectado</p>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="leaderboard-screen" class="overlay hidden">
Â  Â  Â  Â  <div class="ui-card">
Â  Â  Â  Â  Â  Â  <h1>TOP MUNDIAL</h1>
Â  Â  Â  Â  Â  Â  <div class="shop-coin-tag">Tu RÃ©cord: <span id="my-cloud-high">0</span>m</div>
Â  Â  Â  Â  Â  Â  <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; font-size:10px; color:#f1c40f; margin-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;"><span>PILOTO</span><span>DISTANCIA</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="leaderboard-list" style="max-height: 200px; overflow-y: auto; font-size: 12px; text-align: left;">Cargando...</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="btn-red" onclick="showMenu()">VOLVER</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="pause-screen" class="overlay hidden">
Â  Â  Â  Â  <div class="ui-card">
Â  Â  Â  Â  Â  Â  <h1>PAUSA</h1>
Â  Â  Â  Â  Â  Â  <button class="btn-green" onclick="togglePause()">CONTINUAR</button>
Â  Â  Â  Â  Â  Â  <button class="btn-red" onclick="showMenu()">MENÃš</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="revive-screen" class="overlay hidden">
Â  Â  Â  Â  <div class="ui-card">
Â  Â  Â  Â  Â  Â  <h1 style="color:var(--accent);">Â¿CONTINUAR?</h1>
Â  Â  Â  Â  Â  Â  <div id="timer-display">5</div>
Â  Â  Â  Â  Â  Â  <p style="font-size: 14px; color:#bdc3c7; margin-bottom: 20px;">Costo: ğŸ’°250 monedas</p>
Â  Â  Â  Â  Â  Â  <button class="btn-green" onclick="confirmRevive()">SÃ (PAGAR)</button>
Â  Â  Â  Â  Â  Â  <button class="btn-red" onclick="finishGame()" style="background:transparent; border:1px solid #e74c3c; color:#e74c3c; margin-top:10px;">NO, FINALIZAR</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="shop-main" class="overlay hidden">
Â  Â  Â  Â  <div class="ui-card">
Â  Â  Â  Â  Â  Â  <h1>GARAJE</h1>
Â  Â  Â  Â  Â  Â  <div class="shop-coin-tag">ğŸ’° <span class="shop-coin-display">0</span></div>
Â  Â  Â  Â  Â  Â  <button class="btn-blue" onclick="openConcesionario()">AUTOS</button>
Â  Â  Â  Â  Â  Â  <button class="btn-orange" onclick="openMejoras()">MEJORAS</button>
Â  Â  Â  Â  Â  Â  <button class="btn-green" onclick="openLogros()" style="background: var(--weekly-clr);">LOGROS</button>
Â  Â  Â  Â  Â  Â  <button class="btn-red" onclick="showMenu()">VOLVER</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="shop-cars" class="overlay hidden">
Â  Â  Â  Â  <div class="ui-card">
Â  Â  Â  Â  Â  Â  <h1>TIENDA</h1>
Â  Â  Â  Â  Â  Â  <div class="shop-coin-tag">ğŸ’° <span class="shop-coin-display">0</span></div>
Â  Â  Â  Â  Â  Â  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div onclick="prevCar()" style="cursor:pointer; font-size:30px;">â—€</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align:center;"><img id="shop-car-img" style="height:90px; object-fit:contain;"><h4 id="shop-car-name" style="color:#f1c40f; margin:10px 0;"></h4><div style="font-size:11px; color:#bdc3c7;"><span id="shop-car-speed"></span> | <span id="shop-car-lives"></span></div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div onclick="nextCar()" style="cursor:pointer; font-size:30px;">â–¶</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="shop-car-btn" class="btn-green"></button>
Â  Â  Â  Â  Â  Â  <button class="btn-red" onclick="openShop()" style="margin-top:5px;">ATRÃS</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="shop-logros" class="overlay hidden">
Â  Â  Â  Â  <div class="ui-card">
Â  Â  Â  Â  Â  Â  <h1>LOGROS</h1>
Â  Â  Â  Â  Â  Â  <div class="shop-coin-tag">ğŸ’° <span class="shop-coin-display">0</span></div>
Â  Â  Â  Â  Â  Â  <div id="logros-container" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;"></div>
Â  Â  Â  Â  Â  Â  <button class="btn-red" onclick="openShop()">ATRÃS</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="shop-neones" class="overlay hidden">
Â  Â  Â  Â  <div class="ui-card">
Â  Â  Â  Â  Â  Â  <h1>NEONES</h1>
Â  Â  Â  Â  Â  Â  <div class="shop-coin-tag">ğŸ’° <span class="shop-coin-display">0</span></div>
Â  Â  Â  Â  Â  Â  <div id="neon-container" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;"></div>
Â  Â  Â  Â  Â  Â  <button class="btn-red" onclick="openMejoras()">ATRÃS</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="shop-upgrades" class="overlay hidden">
Â  Â  Â  Â  <div class="ui-card">
Â  Â  Â  Â  Â  Â  <h1>MEJORAS</h1>
Â  Â  Â  Â  Â  Â  <div class="shop-coin-tag">ğŸ’° <span class="shop-coin-display">0</span></div>
Â  Â  Â  Â  Â  Â  <p id="up-car-name" style="color:#f1c40f; font-size:14px;"></p>
Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:10px; margin:15px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex:1; background:rgba(255,255,255,0.05); padding:10px; border-radius:15px;"><small>MOTOR</small><br><b>Lvl <span id="lvl-motor">0</span></b><button class="btn-orange" onclick="prepUpgrade('motor')" id="cost-motor" style="font-size:10px; padding:8px; min-width:auto; margin-top:5px;"></button></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex:1; background:rgba(255,255,255,0.05); padding:10px; border-radius:15px;"><small>TANQUE</small><br><b>Lvl <span id="lvl-tanque">0</span></b><button class="btn-orange" onclick="prepUpgrade('tanque')" id="cost-tanque" style="font-size:10px; padding:8px; min-width:auto; margin-top:5px;"></button></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="btn-green" onclick="openNeones()" style="background: linear-gradient(90deg, #3498db, #2ecc71); margin-bottom:15px;">COLOR DE LUCES</button>
Â  Â  Â  Â  Â  Â  <button class="btn-red" onclick="openShop()">ATRÃS</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="upgrade-modal" class="overlay hidden" style="z-index: 300;">
Â  Â  Â  Â  <div class="ui-card">
Â  Â  Â  Â  Â  Â  <h1 id="modal-title">MEJORAR</h1>
Â  Â  Â  Â  Â  Â  <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  <p id="modal-desc" style="font-size: 14px; margin: 0; line-height: 1.4; color: #bdc3c7;"></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="btn-green" onclick="confirmUpgrade()">COMPRAR</button>
Â  Â  Â  Â  Â  Â  <button class="btn-red" onclick="closeUpgradeModal()" style="background:transparent; border: 1px solid #e74c3c; color:#e74c3c; margin-top:10px;">CANCELAR</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="game-over" class="overlay hidden">
Â  Â  Â  Â  <div class="ui-card">
Â  Â  Â  Â  Â  Â  <h1 id="over-title" style="color:#e74c3c;">FIN</h1>
Â  Â  Â  Â  Â  Â  <p id="over-reason" style="font-weight:bold;"></p>
Â  Â  Â  Â  Â  Â  <p id="final-stats" style="color:#bdc3c7; font-size:14px;"></p>
Â  Â  Â  Â  Â  Â  <div id="mission-complete-msg" style="color:#f1c40f; font-weight:bold; margin-bottom:15px;" class="hidden">Â¡MISIÃ“N COMPLETADA!</div>
Â  Â  Â  Â  Â  Â  <button class="btn-green" onclick="startGame()">REINTENTAR</button>
Â  Â  Â  Â  Â  Â  <button class="btn-blue" onclick="showMenu()">MENÃš PRINCIPAL</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <canvas id="gameCanvas"></canvas>
</div>

<script type="module">
Â  Â  // ---------------------------------------------------------
Â  Â  // CONFIGURACIÃ“N DE FIREBASE
Â  Â  // ---------------------------------------------------------
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
Â  Â  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
Â  Â  import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyDow-SMA0L_rp-i5wRa7Cm9kwqvv6Qku64",
Â  Â  Â  authDomain: "racing-arcade.firebaseapp.com",
Â  Â  Â  projectId: "racing-arcade",
Â  Â  Â  storageBucket: "racing-arcade.firebasestorage.app",
Â  Â  Â  messagingSenderId: "152595295248",
Â  Â  Â  appId: "1:152595295248:web:81bf78341546dcb35e2e95"
Â  Â  };

Â  Â  let app, auth, db;
Â  Â  let currentUser = null;

Â  Â  try {
Â  Â  Â  Â  app = initializeApp(firebaseConfig);
Â  Â  Â  Â  auth = getAuth(app);
Â  Â  Â  Â  db = getFirestore(app);
Â  Â  Â  Â  console.log("Firebase conectado");
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error Firebase:", e);
Â  Â  }

Â  Â  // --- SISTEMA DE AUDIO (MEZCLA COMPLETA) ---
Â  Â  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
Â  Â Â 
Â  Â  // Lista de sonidos (HÃ­brida m4a/mp3)
Â  Â  const sonidos = {
Â  Â  Â  Â  motor: { url: 'sonidos/motor.m4a', buffer: null, source: null },
Â  Â  Â  Â  music_menu: { url: 'sonidos/music_menu.m4a', buffer: null, source: null },
Â  Â  Â  Â  music_race: { url: 'sonidos/music_race.m4a', buffer: null, source: null },
Â  Â  Â  Â  coin: { url: 'sonidos/coin.m4a', buffer: null },
Â  Â  Â  Â  crash: { url: 'sonidos/crash.m4a', buffer: null },
Â  Â  Â  Â  click: { url: 'sonidos/click.m4a', buffer: null },
Â  Â  Â  Â  oil: { url: 'sonidos/oil.m4a', buffer: null },
Â  Â  Â  Â  explosion: { url: 'sonidos/explosion.mp3', buffer: null },
Â  Â  Â  Â  game_over: { url: 'sonidos/game_over.mp3', buffer: null },
Â  Â  Â  Â  near: { url: 'sonidos/near.mp3', buffer: null },
Â  Â  Â  Â  heart: { url: 'sonidos/heart.mp3', buffer: null },
Â  Â  Â  Â  fuel: { url: 'sonidos/fuel.m4a', buffer: null }
Â  Â  };

Â  Â  async function cargarSonidos() {
Â  Â  Â  Â  for (const key in sonidos) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(sonidos[key].url);
Â  Â  Â  Â  Â  Â  Â  Â  const arrayBuffer = await response.arrayBuffer();
Â  Â  Â  Â  Â  Â  Â  Â  sonidos[key].buffer = await audioCtx.decodeAudioData(arrayBuffer);
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error audio: " + key, e);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function playSound(name, loop = false) {
Â  Â  Â  Â  if (!sonidos[name].buffer) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (loop && sonidos[name].source) {
Â  Â  Â  Â  Â  Â  try { sonidos[name].source.stop(); } catch(e){}
Â  Â  Â  Â  }

Â  Â  Â  Â  const source = audioCtx.createBufferSource();
Â  Â  Â  Â  source.buffer = sonidos[name].buffer;
Â  Â  Â  Â  source.loop = loop;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const gainNode = audioCtx.createGain();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- MEZCLA DE VOLUMEN ---
Â  Â  Â  Â  if (name === 'motor') gainNode.gain.value = 0.6;Â  Â  Â  Â 
Â  Â  Â  Â  else if (name.includes('music')) gainNode.gain.value = 0.25;Â 
Â  Â  Â  Â  else if (name === 'coin') gainNode.gain.value = 0.2;Â  Â 
Â  Â  Â  Â  else if (name === 'near') gainNode.gain.value = 0.5;Â 
Â  Â  Â  Â  else if (name === 'heart') gainNode.gain.value = 0.6;
Â  Â  Â  Â  else if (name === 'fuel') gainNode.gain.value = 0.4;
Â  Â  Â  Â  else gainNode.gain.value = 0.8;Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  source.connect(gainNode);
Â  Â  Â  Â  gainNode.connect(audioCtx.destination);
Â  Â  Â  Â Â 
Â  Â  Â  Â  source.start(0);
Â  Â  Â  Â  sonidos[name].source = source;
Â  Â  }

Â  Â  function stopSound(name) {
Â  Â  Â  Â  if (sonidos[name] && sonidos[name].source) {
Â  Â  Â  Â  Â  Â  try {Â 
Â  Â  Â  Â  Â  Â  Â  Â  sonidos[name].source.stop();Â 
Â  Â  Â  Â  Â  Â  Â  Â  sonidos[name].source = null;
Â  Â  Â  Â  Â  Â  } catch(e) {}
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function actualizarMotor(velocidad) {
Â  Â  Â  Â  if (sonidos.motor.source) {
Â  Â  Â  Â  Â  Â  let pitch = 0.8 + (velocidad / 25);Â 
Â  Â  Â  Â  Â  Â  sonidos.motor.source.playbackRate.value = pitch;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  window.addEventListener('click', () => {
Â  Â  Â  Â  if (audioCtx.state === 'suspended') audioCtx.resume();
Â  Â  Â  Â  cargarSonidos();
Â  Â  }, { once: true });

Â  Â  // ------------------------------------

Â  Â  window.loginGoogle = async function() {
Â  Â  Â  Â  playSound('click');
Â  Â  Â  Â  if (!auth) return showToast("ERROR", "Fallo conexiÃ³n Firebase");
Â  Â  Â  Â  const provider = new GoogleAuthProvider();
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await signInWithPopup(auth, provider);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  showToast("ERROR LOGIN", error.message);
Â  Â  Â  Â  }
Â  Â  };

Â  Â  window.openRanking = async function() {
Â  Â  Â  Â  playSound('click');
Â  Â  Â  Â  hideAll();
Â  Â  Â  Â  document.getElementById("leaderboard-screen").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("my-cloud-high").innerText = garage.high;
Â  Â  Â  Â  const list = document.getElementById("leaderboard-list");
Â  Â  Â  Â  list.innerHTML = "Cargando...";

Â  Â  Â  Â  if (!db) { list.innerHTML = "Error de conexiÃ³n"; return; }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const q = query(collection(db, "racing_users"), orderBy("high", "desc"), limit(10));
Â  Â  Â  Â  Â  Â  const querySnapshot = await getDocs(q);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  list.innerHTML = "";
Â  Â  Â  Â  Â  Â  let rank = 1;
Â  Â  Â  Â  Â  Â  querySnapshot.forEach((doc) => {
Â  Â  Â  Â  Â  Â  Â  Â  const d = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  const isMe = currentUser && doc.id === currentUser.uid;
Â  Â  Â  Â  Â  Â  Â  Â  const row = document.createElement("div");
Â  Â  Â  Â  Â  Â  Â  Â  row.style.cssText = `display:flex; justify-content:space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: ${isMe ? '#f1c40f' : 'white'};`;
Â  Â  Â  Â  Â  Â  Â  Â  row.innerHTML = `<span>#${rank} ${d.name || "AnÃ³nimo"}</span> <b>${d.high}m</b>`;
Â  Â  Â  Â  Â  Â  Â  Â  list.appendChild(row);
Â  Â  Â  Â  Â  Â  Â  Â  rank++;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if(rank === 1) list.innerHTML = "AÃºn no hay rÃ©cords.";
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  list.innerHTML = "Error al cargar.";
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  }
Â  Â  };

Â  Â  if (auth) {
Â  Â  Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  Â  Â  Â  const btn = document.getElementById("btn-login");
Â  Â  Â  Â  Â  Â  const status = document.getElementById("user-status");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = user;
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "DESCONECTAR";
Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => { playSound('click'); signOut(auth); };
Â  Â  Â  Â  Â  Â  Â  Â  status.innerText = "Piloto: " + user.displayName;
Â  Â  Â  Â  Â  Â  Â  Â  status.style.color = "#2ecc71";
Â  Â  Â  Â  Â  Â  Â  Â  await loadCloudData(user);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = null;
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "â˜ï¸ CONECTAR CON GOOGLE";
Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = window.loginGoogle;
Â  Â  Â  Â  Â  Â  Â  Â  status.innerText = "Juego Local (Sin guardar en nube)";
Â  Â  Â  Â  Â  Â  Â  Â  status.style.color = "#bdc3c7";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  async function loadCloudData(user) {
Â  Â  Â  Â  const docRef = doc(db, "racing_users", user.uid);
Â  Â  Â  Â  const docSnap = await getDoc(docRef);

Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  const cloudData = docSnap.data();
Â  Â  Â  Â  Â  Â  if (cloudData.totalDist > garage.totalDist) {
Â  Â  Â  Â  Â  Â  Â  Â  garage = { ...garage, ...cloudData };
Â  Â  Â  Â  Â  Â  Â  Â  saveLocal();
Â  Â  Â  Â  Â  Â  Â  Â  showToast("NUBE", "Datos descargados");
Â  Â  Â  Â  Â  Â  Â  Â  updateUI();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  saveToCloud();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  saveToCloud();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function saveToCloud() {
Â  Â  Â  Â  if (!currentUser || !db) return;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await setDoc(doc(db, "racing_users", currentUser.uid), {
Â  Â  Â  Â  Â  Â  Â  Â  ...garage,
Â  Â  Â  Â  Â  Â  Â  Â  name: currentUser.displayName
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch (e) { console.error("Error save cloud:", e); }
Â  Â  }

Â  Â  // ---------------------------------------------------------
Â  Â  // LÃ“GICA DEL JUEGO
Â  Â  // ---------------------------------------------------------

Â  Â  const canvas = document.getElementById("gameCanvas");
Â  Â  const ctx = canvas.getContext("2d", { alpha: false });
Â  Â  canvas.width = 400; canvas.height = 750;
Â  Â  ctx.imageSmoothingEnabled = false;

Â  Â  if(/Android|iPhone/i.test(navigator.userAgent)) document.getElementById("mobile-controls").style.display = "flex";

Â  Â  window.requestFullScreen = function() {
Â  Â  Â  Â  let elem = document.documentElement;
Â  Â  Â  Â  if (elem.requestFullscreen) elem.requestFullscreen();
Â  Â  Â  Â  else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
Â  Â  Â  Â  else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
Â  Â  }

Â  Â  const assets = {Â 
Â  Â  Â  Â  player: new Image(), fuel: new Image(), coin: new Image(), truck: new Image(), oil: new Image(),Â 
Â  Â  Â  Â  heart: new Image(), bomb: new Image(), exp: new Image(), magnet: new Image(), npcs: [],
Â  Â  Â  Â  topadora: new Image(), pavimentadora: new Image(), valla: new Image(), cono: new Image()
Â  Â  };
Â  Â  assets.fuel.src = 'Items/bidon_nafta.png'; assets.coin.src = 'Items/moneda_pixel.png'; assets.truck.src = 'Autos/camion_cisterna.png';Â 
Â  Â  assets.oil.src = 'Items/charco_aceite.png'; assets.heart.src = 'Items/heart_pixel.png'; assets.bomb.src = 'Items/bomba.png'; assets.exp.src = 'Items/explosion.png';
Â  Â  assets.magnet.src = 'Items/iman_pixel.png';
Â  Â  assets.topadora.src = 'Items/topadora.png';Â 
Â  Â  assets.pavimentadora.src = 'Items/pavimentadora.png';
Â  Â  assets.valla.src = 'Items/valla.png'; assets.cono.src = 'Items/cono.png';

Â  Â  ['npc_azul.png', 'npc_blanco.png', 'npc_taxi.png', 'npc_rojo.png', 'npc_gris.png'].forEach(n => { let i = new Image(); i.src = `Autos/${n}`; assets.npcs.push(i); });
Â  Â  const sceneryAssets = { arboles: [new Image()] }; sceneryAssets.arboles[0].src = 'Entorno/arbol_1.png';

Â  Â  const MODELS = {
Â  Â  Â  Â  'fitito': { name: 'EL COMPACTO', maxSpeed: 5.75, accel: 0.08, handling: 1.2, lives: 3, w: 45, h: 82, img: 'auto_inicial.png', price: 0 },
Â  Â  Â  Â  'furgoneta': { name: 'CARGO VIAJES', maxSpeed: 6.25, accel: 0.07, handling: 1.0, lives: 3, w: 55, h: 95, img: 'furgoneta.png', price: 3000 },
Â  Â  Â  Â  'auto_rosa': { name: 'PINKY', maxSpeed: 7.17, accel: 0.1, handling: 1.2, lives: 4, w: 58, h: 98, img: 'auto_rosa.png', price: 5500 },
Â  Â  Â  Â  'camioneta4x4': { name: 'TODO TERRENO', maxSpeed: 7.5, accel: 0.12, handling: 1.0, lives: 5, w: 65, h: 115, img: 'camioneta4x4.png', price: 11000 },
Â  Â  Â  Â  'camaro': { name: 'DARK PONY', maxSpeed: 7.92, accel: 0.14, handling: 0.9, lives: 5, w: 52, h: 94, img: 'camaro_negro.png', price: 15000 },
Â  Â  Â  Â  'subaru': { name: 'BLUE RALLY', maxSpeed: 8.08, accel: 0.15, handling: 1.5, lives: 4, w: 44, h: 86, img: 'subaru.png', price: 25000 },
Â  Â  Â  Â  'lambo': { name: 'ITALIA GTR', maxSpeed: 8.75, accel: 0.18, handling: 1.6, lives: 4, w: 42, h: 76, img: 'lambo_amarillo.png', price: 30000 },
Â  Â  Â  Â  'porsche': { name: 'DEPORTIVO GT', maxSpeed: 8.92, accel: 0.2, handling: 1.8, lives: 4, w: 62, h: 98, img: 'porsche_negro.png', price: 47000 },
Â  Â  Â  Â  'skyline': { name: 'NIGHT WALKER', maxSpeed: 9.58, accel: 0.22, handling: 2.0, lives: 4, w: 48, h: 88, img: 'skyline.png', price: 60000 },
Â  Â  Â  Â  'supra': { name: 'TURBO LEGEND', maxSpeed: 9.58, accel: 0.22, handling: 2.0, lives: 4, w: 43, h: 78, img: 'supra.png', price: 60000 },
Â  Â  Â  Â  'mercedes': { name: 'SILVER LUX', maxSpeed: 9.83, accel: 0.24, handling: 2.2, lives: 4, w: 51, h: 90, img: 'mercedes_blanco.png', price: 68000 },
Â  Â  Â  Â  'f1_clasico': { name: 'PRIME ONE', maxSpeed: 10.0, accel: 0.28, handling: 2.5, lives: 2, w: 58, h: 110, img: 'f1_clasico.png', price: 85000 },
Â  Â  Â  Â  'f1_nuevo': { name: 'APEX FORMULA', maxSpeed: 10.42, accel: 0.3, handling: 2.6, lives: 2, w: 48, h: 105, img: 'f1_nuevo.png', price: 95000 }
Â  Â  };

Â  Â  const UPGRADE_PRICES = {
Â  Â  Â  Â  'fitito': [250, 500, 750, 1000, 1250], 'furgoneta': [400, 800, 1200, 1600, 2000], 'auto_rosa': [600, 1200, 1800, 2400, 3000], 'camioneta4x4': [800, 1600, 2400, 3200, 4000], 'camaro': [1000, 2000, 3000, 4000, 5000], 'subaru': [1200, 2400, 3600, 4800, 6000], 'lambo': [1500, 3000, 4500, 6000, 7500], 'porsche': [1500, 3000, 4500, 6000, 7500], 'skyline': [2000, 4000, 6000, 8000, 10000], 'supra': [2000, 4000, 6000, 8000, 10000], 'mercedes': [3000, 6000, 9000, 12000, 15000], 'f1_clasico': [3000, 6000, 10000, 15000, 20000], 'f1_nuevo': [5000, 10000, 15000, 20000, 25000]
Â  Â  };

Â  Â  const DAILY_MISSIONS = [
Â  Â  Â  Â  { id: 0, desc: "Junta 50 monedas en una carrera", goal: 50, type: 'coins' }, { id: 1, desc: "Logra 10 Near Miss en una carrera", goal: 10, type: 'nearmiss' }, { id: 2, desc: "Llega al Nivel 5 en una carrera", goal: 5, type: 'level' }, { id: 3, desc: "Logra 20 Near Miss en una carrera", goal: 20, type: 'nearmiss' }, { id: 4, desc: "Recorre 3000m en una carrera", goal: 3000, type: 'dist' }, { id: 5, desc: "Junta 100 monedas en una carrera", goal: 100, type: 'coins' }
Â  Â  ];

Â  Â  const MILESTONES = { totalDist: [1000, 5000, 10000, 50000, 100000], totalCoins: [500, 2000, 5000, 10000, 50000], totalPlays: [10, 50, 100, 250, 500], totalNear: [50, 200, 500, 1000, 5000] };

Â  Â  const NEONES = {
Â  Â  Â  Â  'white': { name: 'BLANCO', color: [255, 250, 200], price: 0 }, 'blue': { name: 'AZUL HIELO', color: [0, 200, 255], price: 5000 }, 'green': { name: 'VERDE NEON', color: [50, 255, 50], price: 5000 }, 'red': { name: 'ROJO FUEGO', color: [255, 50, 50], price: 5000 }, 'pink': { name: 'PINK ARCADE', color: [255, 50, 255], price: 8000 }, 'gold': { name: 'ORO PURO', color: [255, 215, 0], price: 15000 }
Â  Â  };

Â  Â  window.garage = { owned: ['fitito'], selected: 'fitito', coins: 0, high: 0, missionId: 0, missionDoneDate: "", carStats: {}, neonOwned: ['white'], selectedNeon: 'white', totalDist: 0, totalPlays: 0, totalNear: 0, totalCoinsRec: 0, unlockedLogros: {totalDist:0, totalCoins:0, totalPlays:0, totalNear:0}, weeklyDist: 0, weeklyWeek: -1, weeklyDone: false };

Â  Â  window.save = function() {Â 
Â  Â  Â  Â  saveLocal();
Â  Â  Â  Â  saveToCloud();Â 
Â  Â  }

Â  Â  function saveLocal() {
Â  Â  Â  Â  localStorage.setItem('borrione_racing_v3', JSON.stringify(garage));Â 
Â  Â  Â  Â  updateShopCoinDisplays();
Â  Â  }

Â  Â  const saved = localStorage.getItem('borrione_racing_v3'); if(saved) garage = {...garage, ...JSON.parse(saved)};
Â  Â  Object.keys(MODELS).forEach(k => { if(!garage.carStats[k]) garage.carStats[k] = {motor:0, tanque:0}; });

Â  Â  window.showToast = function(title, msg, isAchievement = false) {
Â  Â  Â  Â  const container = document.getElementById("toast-container"); const t = document.createElement("div"); t.className = `toast ${isAchievement ? 'logro' : ''}`; t.innerHTML = `<b>${title}</b><p>${msg}</p>`; container.appendChild(t); setTimeout(() => t.remove(), 3200);
Â  Â  }

Â  Â  function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); return Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(),0,1))) / 86400000) + 1)/7); }

Â  Â  window.actualizarEstructuraMisiones = function() {
Â  Â  Â  Â  const hoy = new Date().toDateString(); const currWeek = getWeekNumber(new Date()); if(garage.weeklyWeek !== currWeek) { garage.weeklyWeek = currWeek; garage.weeklyDist = 0; garage.weeklyDone = false; }
Â  Â  Â  Â  garage.missionId = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000) % DAILY_MISSIONS.length;
Â  Â  Â  Â  document.getElementById("menu-mission-desc").innerText = (garage.missionDoneDate !== hoy) ? DAILY_MISSIONS[garage.missionId].desc : "Â¡Completada!";
Â  Â  Â  Â  document.getElementById("menu-weekly-desc").innerText = garage.weeklyDone ? "Â¡MisiÃ³n completada!" : `Meta: ${garage.weeklyDist.toLocaleString()} / 50.000m`;
Â  Â  Â  Â  document.getElementById("weekly-bar").style.width = Math.min(100, (garage.weeklyDist/50000)*100) + "%";
Â  Â  }

Â  Â  let state = "LOADING", currentSpeed = 0, roadY = 0, score = 0, fuel = 100, lives = 3, level = 1, shopIndex = 0, lastTime = 0;
Â  Â  let player = { x: 0, y: 0, vx: 0, w: 0, h: 0 }, enemies = [], items = [], scenery = [], keys = {}, nmT = null, isS = false, expObj = null, coinsThisRun = 0, nearMissesThisRun = 0, heartSpawnedInLevel = false, hasRevived = false, lastReason = "", reviveCounter = 5, reviveInterval = null, screenShake = 0, magnetTimer = 0;

Â  Â  let constEvent = { active: false, lane: -1, remaining: 0, spawnTimer: 0, isFirst: true, coneDist: 0 };

Â  Â  window.startGame = function() {
Â  Â  Â  Â  const car = MODELS[garage.selected]; assets.player.src = `Autos/${car.img}`; player = { x: 200 - car.w/2, y: 550, w: car.w, h: car.h, vx: 0 }; score = 0; fuel = 100; lives = car.lives; currentSpeed = 0; roadY = 0; level = 1; enemies = []; items = []; scenery = []; expObj = null; heartSpawnedInLevel = true; coinsThisRun = 0; nearMissesThisRun = 0; hasRevived = false; screenShake = 0; magnetTimer = 0; constEvent = { active: false, lane: -1, remaining: 0, spawnTimer: 0, isFirst: true, coneDist: 0 };
Â  Â  Â  Â  state = "PLAYING"; hideAll(); document.getElementById("btn-pause-trigger").style.display = "flex"; lastTime = performance.now();Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  playSound('click');Â 
Â  Â  Â  Â  stopSound('music_menu');
Â  Â  Â  Â  playSound('music_race', true);Â 
Â  Â  Â  Â  playSound('motor', true);
Â  Â  Â  Â Â 
Â  Â  Â  Â  loop();
Â  Â  }

Â  Â  window.togglePause = function() {Â 
Â  Â  Â  Â  if(state !== "PLAYING" && state !== "PAUSED") return;Â 
Â  Â  Â  Â  state = (state === "PAUSED") ? "PLAYING" : "PAUSED";Â 
Â  Â  Â  Â  playSound('click');
Â  Â  Â  Â  if(state === "PAUSED") {
Â  Â  Â  Â  Â  Â  document.getElementById("pause-screen").classList.remove("hidden");Â 
Â  Â  Â  Â  Â  Â  stopSound('motor');Â 
Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  document.getElementById("pause-screen").classList.add("hidden");Â 
Â  Â  Â  Â  Â  Â  playSound('motor', true);Â 
Â  Â  Â  Â  Â  Â  lastTime = performance.now(); loop();Â 
Â  Â  Â  Â  }Â 
Â  Â  }

Â  Â  function loop(t) { if(state !== "PLAYING") return; let dt = (t - lastTime) / 16.66; if(isNaN(dt) || dt > 3) dt = 1; lastTime = t; update(dt); draw(); requestAnimationFrame(loop); }

Â  Â  function update(dt) {
Â  Â  Â  Â  const car = MODELS[garage.selected], stats = garage.carStats[garage.selected];Â 
Â  Â  Â  Â  let nextLvl = (score < 4000) ? Math.floor(score / 500) + 1 : 9 + Math.floor((score - 4000) / 1000);
Â  Â  Â  Â  if(nextLvl > level) heartSpawnedInLevel = false;
Â  Â  Â  Â  level = nextLvl;
Â  Â  Â  Â  const mSpd = car.maxSpeed + (stats.motor * 0.4); let hndl = car.handling;Â 
Â  Â  Â  Â  let rain = (level >= 6 && (level - 6) % 4 === 1);Â 
Â  Â  Â  Â  let turnInertia = 0.8;Â 
Â  Â  Â  Â  if(rain) { hndl *= 0.30; turnInertia = 0.97; }
Â  Â  Â  Â  if(isS) { currentSpeed = Math.max(currentSpeed * 0.9, mSpd * 0.1); player.vx = 0; }
Â  Â  Â  Â  else { if(keys["ArrowUp"] || keys["GAS"]) currentSpeed = Math.min(currentSpeed + car.accel * dt, mSpd); else if(keys["ArrowDown"]) currentSpeed = Math.max(currentSpeed - 0.25 * dt, 0); else currentSpeed = Math.max(currentSpeed - 0.05 * dt, 0); if(keys["ArrowLeft"]) player.vx -= hndl * dt; if(keys["ArrowRight"]) player.vx += hndl * dt; }
Â  Â  Â  Â  player.vx *= Math.pow(turnInertia, dt); player.x += player.vx * dt; if(player.x < 35) player.x = 35; if(player.x > 365 - player.w) player.x = 365 - player.w; roadY += currentSpeed * dt; score += currentSpeed * 0.05 * dt;Â 
Â  Â  Â  Â  fuel -= (0.016 - (stats.tanque * 0.0015)) * currentSpeed * dt;
Â  Â  Â  Â  if(screenShake > 0.1) screenShake *= 0.85; if(magnetTimer > 0) { magnetTimer -= dt; document.getElementById("ui-coin-label").classList.add("magnet-active"); } else document.getElementById("ui-coin-label").classList.remove("magnet-active");
Â  Â  Â  Â Â 
Â  Â  Â  Â  actualizarMotor(currentSpeed);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(!constEvent.active && level >= 3 && Math.random() < 0.0005 * dt) {
Â  Â  Â  Â  Â  Â  constEvent.active = true;
Â  Â  Â  Â  Â  Â  constEvent.lane = Math.random() < 0.5 ? 0 : 3;Â 
Â  Â  Â  Â  Â  Â  constEvent.remaining = 400 + Math.random() * 800;Â 
Â  Â  Â  Â  Â  Â  constEvent.isFirst = true;Â 
Â  Â  Â  Â  Â  Â  constEvent.spawnTimer = 0;
Â  Â  Â  Â  Â  Â  constEvent.coneDist = 0;
Â  Â  Â  Â  Â  Â  showToast("ğŸš§ OBRAS", "Carril bloqueado adelante");
Â  Â  Â  Â  }

Â  Â  Â  Â  if(constEvent.active) {
Â  Â  Â  Â  Â  Â  constEvent.remaining -= currentSpeed * 0.05 * dt;
Â  Â  Â  Â  Â  Â  if(constEvent.remaining <= 0) constEvent.active = false;
Â  Â  Â  Â  Â  Â  constEvent.coneDist += currentSpeed * dt;
Â  Â  Â  Â  Â  Â  if(constEvent.coneDist >= 45) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  spawnConstructionItem('cono_line');
Â  Â  Â  Â  Â  Â  Â  Â  constEvent.coneDist = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  constEvent.spawnTimer -= dt;
Â  Â  Â  Â  Â  Â  if(constEvent.spawnTimer <= 0 && constEvent.remaining > 50) {
Â  Â  Â  Â  Â  Â  Â  Â  if(constEvent.isFirst) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  spawnConstructionItem('valla_start');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  constEvent.isFirst = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  constEvent.spawnTimer = 70;Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  spawnConstructionItem('machine');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  constEvent.spawnTimer = 140 + Math.random() * 60;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if(Math.random() < (0.015 + level*0.005) * dt) spawnTraffic(); if(Math.random() < 0.02 * dt) spawnScenery(); if(Math.random() < 0.006 * dt) spawnItem('coin');Â 
Â  Â  Â  Â  if(Math.random() < 0.007 * dt) spawnItem('fuel');Â 
Â  Â  Â  Â  if(Math.random() < 0.0008 * dt) spawnItem('magnet');Â 
Â  Â  Â  Â  if(level >= 2 && !heartSpawnedInLevel && Math.random() < 0.001 * dt) { spawnItem('heart'); heartSpawnedInLevel = true; }
Â  Â  Â  Â  if(level >= 4 && Math.random() < 0.0025 * dt) spawnItem('oil'); if(level >= 5 && Math.random() < 0.002 * dt) spawnItem('bomb');

Â  Â  Â  Â  enemies.forEach((en, i) => {
Â  Â  Â  Â  Â  Â  let desiredSpeed = en.baseSpeed;
Â  Â  Â  Â  Â  Â  if(en.type !== 'obs') {
Â  Â  Â  Â  Â  Â  Â  Â  let futureLanes = [en.l]; if(en.chg || en.blink) futureLanes.push(en.tl); let ahead = enemies.find(o => o !== en && (futureLanes.includes(o.l) || (o.chg && futureLanes.includes(o.tl))) && o.y < en.y && (en.y - o.y) < (en.h > 90 ? 300 : 240)); if (ahead) { if (en.y - (ahead.y + ahead.h) < 30) desiredSpeed = ahead.speed * 0.5; else desiredSpeed = Math.min(en.baseSpeed, ahead.speed * 0.9); } en.speed += (desiredSpeed - en.speed) * 0.2 * dt;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  en.y += (currentSpeed - en.speed) * dt;
Â  Â  Â  Â  Â  Â  if(en.type !== 'obs' && level >= 3 && !en.chg && !en.blink && Math.random() < 0.002 * dt) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  let nextLane = en.l + (Math.random() < 0.5 ? -1 : 1);Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(nextLane >= 0 && nextLane <= 3 && (!constEvent.active || nextLane !== constEvent.lane)) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let tx = [75, 157.5, 242.5, 325][nextLane] - (en.w / 2);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!enemies.some(o => o !== en && (o.l === nextLane || o.tl === nextLane) && Math.abs(o.y - en.y) < (en.h + o.h + 80))) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  en.blink = true; en.bCount = 0; en.bTimer = 0; en.tx = tx; en.tl = nextLane;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(en.blink && en.type !== 'obs') { en.bTimer += dt; if(en.bTimer > 20) { en.bTimer = 0; en.bCount++; if(en.bCount >= 6) { en.blink = false; en.chg = true; } } }
Â  Â  Â  Â  Â  Â  if(en.chg && en.type !== 'obs') { en.x += (en.x < en.tx ? 2.8 : -2.8) * dt; if(Math.abs(en.x - en.tx) < 4) { en.x = en.tx; en.chg = false; en.l = en.tl; } }
Â  Â  Â  Â  Â  Â  if(!en.nm && en.type !== 'obs' && Math.abs(player.x - en.x) < 48 && Math.abs(player.y - en.y) < 55) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  en.nm = true;Â 
Â  Â  Â  Â  Â  Â  Â  Â  playSound('near'); // <--- SONIDO NEAR MISS
Â  Â  Â  Â  Â  Â  Â  Â  garage.coins += 10; nearMissesThisRun++; fuel = Math.min(100, fuel + 7.5); nmT = {y: player.y, t: 40}; screenShake = 1.5;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(checkCollision(player, en)) {
Â  Â  Â  Â  Â  Â  Â  Â  if(en.type === 'obs') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endGame("OBRAS: MUERTE INSTANTÃNEA");Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('crash');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lives--;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screenShake = 10;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(lives <= 0) endGame("CHOQUE");Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  enemies.splice(i,1);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if(en.y > 850 || en.y < -500) enemies.splice(i,1);
Â  Â  Â  Â  });
Â  Â  Â  Â  items.forEach((it, i) => {
Â  Â  Â  Â  Â  Â  if(it.t === 'coin' && magnetTimer > 0) { let dx = (player.x + player.w/2) - (it.x + it.w/2), dy = (player.y + player.h/2) - (it.y + it.h/2), dist = Math.sqrt(dx*dx + dy*dy); if(dist < 300) { it.x += (dx/dist) * 12 * dt; it.y += (dy/dist) * 12 * dt; } else it.y += currentSpeed * dt; } else it.y += currentSpeed * dt;
Â  Â  Â  Â  Â  Â  if(checkCollision(player, it)) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(it.t === 'coin') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('coin');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let val = (level >= 10) ? 2 : 1; garage.coins += val; coinsThisRun += val; garage.totalCoinsRec += val;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(it.t === 'fuel') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('fuel'); // <--- SONIDO FUEL
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fuel = Math.min(100, fuel+40);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if(it.t === 'heart') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('heart');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lives++;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if(it.t === 'magnet') magnetTimer = 600;Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(it.t === 'oil') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('oil');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isS = true; screenShake = 5; setTimeout(()=>isS=false, 1500);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(it.t === 'bomb') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('explosion');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  expObj = {x: player.x-40, y: player.y-40}; screenShake = 15; setTimeout(()=> endGame("EXPLOSIÃ“N"), 500);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  items.splice(i,1);Â 
Â  Â  Â  Â  Â  Â  } else if(it.y > 800) items.splice(i,1);
Â  Â  Â  Â  });
Â  Â  Â  Â  scenery.forEach((s, i) => { s.y += currentSpeed * dt; if(s.y > 800) scenery.splice(i,1); }); if(nmT) { nmT.t -= dt; if(nmT.t <= 0) nmT = null; } if(fuel <= 0) endGame("SIN NAFTA"); updateHUD();
Â  Â  }

Â  Â  function spawnItem(t) {
Â  Â  Â  Â  let tx;
Â  Â  Â  Â  // CORRECCIÃ“N FINAL: Si es nafta, que aparezca EN el carril, no en el medio (anti-trampa)
Â  Â  Â  Â  if (t === 'fuel') {
Â  Â  Â  Â  Â  Â  Â let lane = Math.floor(Math.random() * 4);
Â  Â  Â  Â  Â  Â  Â // Coordenadas corregidas al milÃ­metro
Â  Â  Â  Â  Â  Â  Â let centers = [76.25, 158.75, 241.25, 323.75];Â  Â Â 
Â  Â  Â  Â  Â  Â  Â tx = centers[lane] - 15; // Centrado exacto
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â tx = 70 + Math.random()*260; // Los demÃ¡s siguen random
Â  Â  Â  Â  }
Â  Â  Â  Â  items.push({ x: tx, y: -50, w: 30, h: 30, t: t, img: assets[t] });
Â  Â  }

Â  Â  function spawnConstructionItem(type) {
Â  Â  Â  Â  let w, h, variant, tx, subType;
Â  Â  Â  Â  if (type === 'cono_line') {
Â  Â  Â  Â  Â  Â  w = 30; h = 30; variant = 'cono';
Â  Â  Â  Â  Â  Â  subType = 'cono';
Â  Â  Â  Â  Â  Â  tx = (constEvent.lane === 0 ? 115 : 285) - (w / 2);
Â  Â  Â  Â  } else if (type === 'valla_start') {
Â  Â  Â  Â  Â  Â  w = 70; h = 50; variant = 'valla';
Â  Â  Â  Â  Â  Â  subType = 'valla';
Â  Â  Â  Â  Â  Â  tx = [75, 157.5, 242.5, 325][constEvent.lane] - (w / 2);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const machines = ['topadora', 'pavimentadora'];
Â  Â  Â  Â  Â  Â  variant = machines[Math.floor(Math.random() * machines.length)];
Â  Â  Â  Â  Â  Â  const sizes = { 'topadora': {w: 56, h: 94}, 'pavimentadora': {w: 60, h: 102} };
Â  Â  Â  Â  Â  Â  w = sizes[variant].w;
Â  Â  Â  Â  Â  Â  h = sizes[variant].h;
Â  Â  Â  Â  Â  Â  subType = 'machine';
Â  Â  Â  Â  Â  Â  tx = [75, 157.5, 242.5, 325][constEvent.lane] - (w / 2);
Â  Â  Â  Â  }
Â  Â  Â  Â  enemies.push({Â 
Â  Â  Â  Â  Â  Â  x: tx, y: -200, l: constEvent.lane, w, h,Â 
Â  Â  Â  Â  Â  Â  type: 'obs', subType: subType, img: assets[variant],Â 
Â  Â  Â  Â  Â  Â  baseSpeed: 0, speed: 0, tx: 0, tl: constEvent.lane, blink: false, bCount: 0, bTimer: 0, chg: falseÂ 
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function drawConstructionLights(x, y, w, h) {
Â  Â  Â  Â  const time = performance.now();
Â  Â  Â  Â  const blinkLeft = Math.floor(time / 250) % 2 === 0;Â 
Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  ctx.shadowBlur = 20;Â 
Â  Â  Â  Â  ctx.shadowColor = "#e67e22";Â 
Â  Â  Â  Â  ctx.fillStyle = blinkLeft ? "#ffaa00" : "#553300";Â 
Â  Â  Â  Â  ctx.beginPath(); ctx.arc(x + 10, y + 5, 6, 0, Math.PI * 2); ctx.fill();
Â  Â  Â  Â  ctx.fillStyle = !blinkLeft ? "#ffaa00" : "#553300";Â 
Â  Â  Â  Â  ctx.beginPath(); ctx.arc(x + w - 10, y + 5, 6, 0, Math.PI * 2); ctx.fill();
Â  Â  Â  Â  ctx.restore();
Â  Â  }

Â  Â  function drawProHeadlights(x, y, w, h, isPlayer, isNight) {
Â  Â  Â  Â  const lightLength = isPlayer ? 230 : 140, lightWidth = isPlayer ? 65 : 45, lightY = y + 15; let c = isPlayer ? (NEONES[garage.selectedNeon].color) : [255, 250, 200];
Â  Â  Â  Â  if(isNight) ctx.globalCompositeOperation = 'lighter';Â 
Â  Â  Â  Â  let grad = ctx.createLinearGradient(x + w/2, lightY, x + w/2, lightY - lightLength); grad.addColorStop(0, `rgba(${c[0]}, ${c[1]}, ${c[2]}, 0.6)`); grad.addColorStop(1, `rgba(${c[0]}, ${c[1]}, ${c[2]}, 0)`); ctx.fillStyle = grad; ctx.beginPath(); ctx.moveTo(x + 10, lightY); ctx.lineTo(x - lightWidth, lightY - lightLength); ctx.lineTo(x + w + lightWidth, lightY - lightLength); ctx.lineTo(x + w - 10, lightY); ctx.fill(); if(isNight) ctx.globalCompositeOperation = 'source-over';
Â  Â  }

Â  Â  function draw() {
Â  Â  Â  Â  ctx.save(); if (screenShake > 0.1) ctx.translate((Math.random()-0.5)*screenShake, (Math.random()-0.5)*screenShake); let sunset = (level >= 6 && (level - 6) % 4 === 0), rain = (level >= 6 && (level - 6) % 4 === 1), night = (level >= 6 && (level - 6) % 4 === 2); ctx.fillStyle = "#1e8449"; ctx.fillRect(0,0,400,750); ctx.fillStyle = "#27ae60"; for(let gy = (roadY%40)-40; gy < 750; gy+=40) { for(let gx = 0; gx < 35; gx+=10) if((gx+gy)%20===0) ctx.fillRect(gx, gy, 4, 4); for(let gx = 365; gx < 400; gx+=10) if((gx+gy)%20===0) ctx.fillRect(gx, gy, 4, 4); }
Â  Â  Â  Â  ctx.fillStyle = "#2c3e50"; ctx.fillRect(35, 0, 330, 750);Â 
Â  Â  Â  Â  ctx.fillStyle = "#34495e"; for(let ay = (roadY%100)-100; ay < 750; ay+=50) { ctx.fillRect(100, ay, 2, 10); ctx.fillRect(300, ay+25, 2, 10); } ctx.fillStyle = "rgba(255,255,255,0.1)"; for(let i = -150; i < 900; i += 150) { ctx.fillRect(115, i + (roadY % 150), 2, 50); ctx.fillRect(200, i + (roadY % 150), 2, 50); ctx.fillRect(285, i + (roadY % 150), 2, 50); } scenery.forEach(s => { if(s.img.complete) ctx.drawImage(s.img, s.x, s.y, s.w, s.h); }); items.forEach(it => { if(it.img.complete) ctx.drawImage(it.img, it.x, it.y, it.w, it.h); }); if(night) { ctx.fillStyle = "rgba(0, 0, 0, 0.70)"; ctx.fillRect(0,0,400,750); }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  enemies.forEach(en => {Â 
Â  Â  Â  Â  Â  Â  if(en.type !== 'obs' && (sunset || rain || night)) drawProHeadlights(en.x, en.y, en.w, en.h, false, night);Â 
Â  Â  Â  Â  Â  Â  if(en.img.complete) ctx.drawImage(en.img, en.x, en.y, en.w, en.h);Â 
Â  Â  Â  Â  Â  Â  if(en.subType === 'valla') drawConstructionLights(en.x, en.y, en.w, en.h);
Â  Â  Â  Â  Â  Â  if(en.type !== 'obs' && en.blink && Math.floor(en.bCount % 2) === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = "#ffa500"; ctx.beginPath(); ctx.arc(en.x + (en.tl < en.l ? 5 : en.w-5), en.y + en.h - 10, 5, 0, Math.PI * 2); ctx.fill();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });Â 
Â  Â  Â  Â  if(!expObj && assets.player.complete) { if(sunset || rain || night) drawProHeadlights(player.x, player.y, player.w, player.h, true, night); ctx.drawImage(assets.player, player.x|0, player.y|0, player.w, player.h); } if(expObj) ctx.drawImage(assets.exp, expObj.x, expObj.y, 140, 140); if(sunset) { ctx.fillStyle = "rgba(255, 100, 0, 0.2)"; ctx.fillRect(0,0,400,750); } if(rain) { ctx.fillStyle = "rgba(0, 100, 255, 0.1)"; ctx.fillRect(0,0,400,750); ctx.strokeStyle = "rgba(255,255,255,0.4)"; for(let r=0; r<15; r++){ let rx=Math.random()*400, ry=Math.random()*750; ctx.beginPath(); ctx.moveTo(rx,ry); ctx.lineTo(rx-5, ry+15); ctx.stroke(); } } if(nmT) { ctx.fillStyle = "#f1c40f"; ctx.font = "bold 20px sans-serif"; ctx.textAlign = "center"; ctx.fillText("Â¡CERCA!", player.x + player.w/2, nmT.y - 20); ctx.textAlign = "left"; } ctx.restore();
Â  Â  }

Â  Â  function checkCollision(p, o) { let mx = 8, my = 12; return p.x + mx < o.x + o.w - mx && p.x + p.w - mx > o.x + mx && p.y + my < o.y + o.h - my && p.y + p.h - my > o.y + my; }
Â  Â  function updateHUD() {Â 
Â  Â  Â  Â  document.getElementById("ui-speed").innerText = (currentSpeed * 12)|0;Â 
Â  Â  Â  Â  document.getElementById("ui-score").innerText = score|0;Â 
Â  Â  Â  Â  document.getElementById("ui-level").innerText = level;Â 
Â  Â  Â  Â  document.getElementById("ui-lives-text").innerText = lives;Â 
Â  Â  Â  Â  document.getElementById("ui-coins-total").innerText = garage.coins.toLocaleString();Â 
Â  Â  Â  Â  const fuelBar = document.getElementById("fuel-bar");
Â  Â  Â  Â  fuelBar.style.width = fuel + "%";
Â  Â  Â  Â  if(fuel < 20) fuelBar.classList.add("fuel-low"); else fuelBar.classList.remove("fuel-low");
Â  Â  }

Â  Â  window.updateShopCoinDisplays = function() { document.querySelectorAll('.shop-coin-display').forEach(d => d.innerText = garage.coins.toLocaleString()); }
Â  Â Â 
Â  Â  window.showMenu = function() {Â 
Â  Â  Â  Â  clearInterval(reviveInterval);Â 
Â  Â  Â  Â  state = "MENU";Â 
Â  Â  Â  Â  hideAll();Â 
Â  Â  Â  Â  document.getElementById("btn-pause-trigger").style.display = "none";Â 
Â  Â  Â  Â  document.getElementById("menu").classList.remove("hidden");Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  stopSound('music_race');
Â  Â  Â  Â  stopSound('motor');
Â  Â  Â  Â  playSound('music_menu', true);Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  updateUI();Â 
Â  Â  Â  Â  actualizarEstructuraMisiones();Â 
Â  Â  }
Â  Â Â 
Â  Â  function hideAll() { document.querySelectorAll('.overlay').forEach(o => o.classList.add('hidden')); }

Â  Â  window.updateUI = function() {Â 
Â  Â  Â  Â  const carKey = garage.selected; const stats = garage.carStats[carKey]; document.getElementById("lvl-motor").innerText = stats.motor; document.getElementById("lvl-tanque").innerText = stats.tanque;
Â  Â  Â  Â  document.getElementById("cost-motor").innerText = stats.motor < 5 ? `$${UPGRADE_PRICES[carKey][stats.motor].toLocaleString()}` : "MAX"; document.getElementById("cost-tanque").innerText = stats.tanque < 5 ? `$${UPGRADE_PRICES[carKey][stats.tanque].toLocaleString()}` : "MAX";
Â  Â  Â  Â  document.getElementById("menu-high-score").innerText = garage.high.toLocaleString(); document.getElementById("menu-total-coins").innerText = garage.coins.toLocaleString(); document.getElementById("up-car-name").innerText = MODELS[carKey].name;
Â  Â  Â  Â  updateShopCoinDisplays();
Â  Â  }

Â  Â  let tempUpgrade = null;
Â  Â  window.prepUpgrade = function(type) {
Â  Â  Â  Â  playSound('click');
Â  Â  Â  Â  const stats = garage.carStats[garage.selected];
Â  Â  Â  Â  const cost = UPGRADE_PRICES[garage.selected][stats[type]];
Â  Â  Â  Â  if(stats[type] >= 5) return;
Â  Â  Â  Â  if(garage.coins < cost) { showToast("ERROR", "No tienes suficientes monedas"); return; }
Â  Â  Â  Â  tempUpgrade = { type, cost };
Â  Â  Â  Â  const nextLvl = stats[type] + 1;
Â  Â  Â  Â  const benefit = type === 'motor' ? "5 KM/H mÃ¡s de velocidad mÃ¡xima" : "un tanque mÃ¡s eficiente (gasta menos)";
Â  Â  Â  Â  document.getElementById("modal-title").innerText = `MEJORAR ${type.toUpperCase()}`;
Â  Â  Â  Â  document.getElementById("modal-desc").innerHTML = `Â¿Quieres instalar el <b>Nivel ${nextLvl}</b>?<br><br>Beneficio: <b>+${benefit}</b>.<br><br>Costo: <span style="color:#f1c40f">$${cost.toLocaleString()}</span>`;
Â  Â  Â  Â  document.getElementById("upgrade-modal").classList.remove("hidden");
Â  Â  }
Â  Â  window.confirmUpgrade = function() {
Â  Â  Â  Â  if(!tempUpgrade) return;
Â  Â  Â  Â  playSound('coin');
Â  Â  Â  Â  garage.coins -= tempUpgrade.cost;
Â  Â  Â  Â  garage.carStats[garage.selected][tempUpgrade.type]++;
Â  Â  Â  Â  save(); updateUI(); closeUpgradeModal();
Â  Â  Â  Â  showToast("Ã‰XITO", "Mejora instalada correctamente");
Â  Â  }
Â  Â  window.closeUpgradeModal = function() {Â 
Â  Â  Â  Â  playSound('click');
Â  Â  Â  Â  document.getElementById("upgrade-modal").classList.add("hidden"); tempUpgrade = null;Â 
Â  Â  }

Â  Â  function spawnTraffic() {Â 
Â  Â  Â  Â  let l = (Math.random()*4)|0;
Â  Â  Â  Â  if(constEvent.active && l === constEvent.lane) return;Â 
Â  Â  Â  Â  let tx = [75, 157.5, 242.5, 325][l], isC = (level >= 2 && Math.random() < 0.3), w = isC ? 55 : 45, h = isC ? 110 : 80;Â 
Â  Â  Â  Â  if(enemies.some(e => Math.abs(e.x - (tx - w/2)) < 55 && e.y < (h + 150))) return;Â 
Â  Â  Â  Â  enemies.push({ x: tx - (w / 2), y: -200, l: l, w: w, h: h, type: 'normal', img: (isC ? assets.truck : assets.npcs[(Math.random()*assets.npcs.length)|0]), baseSpeed: 1.5 + Math.random() * 3.0, speed: 1.5 + Math.random() * 3.0, tx: 0, tl: l, blink: false, bCount: 0, bTimer: 0, chg: false });Â 
Â  Â  }
Â  Â  function spawnScenery() { let s = Math.random() < 0.5 ? 2 : 365; if(!scenery.some(obj => Math.abs(obj.y - (-120)) < 200)) scenery.push({ x: s, y: -120, w: 35, h: 55, img: sceneryAssets.arboles[0] }); }

Â  Â  function endGame(r) {Â 
Â  Â  Â  Â  state = "PAUSED";Â 
Â  Â  Â  Â  lastReason = r;Â 
Â  Â  Â  Â  document.getElementById("btn-pause-trigger").style.display = "none";Â 
Â  Â  Â  Â  stopSound('motor');
Â  Â  Â  Â  stopSound('music_race');
Â  Â  Â  Â  playSound('crash');
Â  Â  Â  Â  playSound('game_over');

Â  Â  Â  Â  if (!hasRevived && garage.coins >= 250 && r !== "OBRAS: MUERTE INSTANTÃNEA") startReviveCountdown(); else finishGame();Â 
Â  Â  }
Â  Â  function startReviveCountdown() { reviveCounter = 5; document.getElementById("timer-display").innerText = reviveCounter; document.getElementById("revive-screen").classList.remove("hidden"); reviveInterval = setInterval(() => { reviveCounter--; document.getElementById("timer-display").innerText = reviveCounter; if (reviveCounter <= 0) finishGame(); }, 1000); }
Â  Â Â 
Â  Â  window.confirmRevive = function() {Â 
Â  Â  Â  Â  clearInterval(reviveInterval);Â 
Â  Â  Â  Â  garage.coins -= 250;Â 
Â  Â  Â  Â  lives = 1;Â 
Â  Â  Â  Â  fuel = 100;Â 
Â  Â  Â  Â  hasRevived = true;Â 
Â  Â  Â  Â  expObj = null;Â 
Â  Â  Â  Â  state = "PLAYING";Â 
Â  Â  Â  Â  hideAll();Â 
Â  Â  Â  Â  document.getElementById("btn-pause-trigger").style.display = "flex";Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Reactivar audio
Â  Â  Â  Â  playSound('music_race', true);
Â  Â  Â  Â  playSound('motor', true);
Â  Â  Â  Â Â 
Â  Â  Â  Â  save();Â 
Â  Â  Â  Â  lastTime = performance.now();Â 
Â  Â  Â  Â  loop();Â 
Â  Â  }

Â  Â  window.finishGame = function() {
Â  Â  Â  Â  clearInterval(reviveInterval); state = "OVER"; hideAll();Â 
Â  Â  Â  Â  let newRec = score > garage.high;
Â  Â  Â  Â  if(newRec) garage.high = score|0;
Â  Â  Â  Â  garage.totalDist += score|0; garage.totalPlays += 1; garage.totalNear += nearMissesThisRun; garage.weeklyDist += score|0; const misionActual = DAILY_MISSIONS[garage.missionId], hoy = new Date().toDateString();
Â  Â  Â  Â  if (garage.missionDoneDate !== hoy) { let comp = (misionActual.type === 'coins' && coinsThisRun >= misionActual.goal) || (misionActual.type === 'nearmiss' && nearMissesThisRun >= misionActual.goal) || (misionActual.type === 'dist' && score >= misionActual.goal) || (misionActual.type === 'level' && level >= misionActual.goal); if (comp) { garage.coins += 500; garage.missionDoneDate = hoy; showToast("MISIÃ“N COMPLETADA", "+ğŸ’°500 monedas"); } }
Â  Â  Â  Â  if(!garage.weeklyDone && garage.weeklyDist >= 50000) { garage.weeklyDone = true; garage.coins += 5000; showToast("Â¡SEMANA SUPERADA!", "+ğŸ’°5.000 monedas", true); }
Â  Â  Â  Â  Object.keys(MILESTONES).forEach(key => { let c = garage.unlockedLogros[key]; if(c < 5 && ((key === 'totalDist' ? garage.totalDist : key === 'totalCoins' ? garage.totalCoinsRec : key === 'totalNear' ? garage.totalNear : garage.totalPlays) >= MILESTONES[key][c])) { garage.unlockedLogros[key]++; garage.coins += 1000; showToast("LOGRO DESBLOQUEADO", `Nivel ${c + 1} de ${key}`, true); } });
Â  Â  Â  Â  save();Â 
Â  Â  Â  Â  document.getElementById("game-over").classList.remove("hidden");
Â  Â  Â  Â  document.getElementById("over-title").innerText = newRec ? "Â¡NUEVO RÃ‰CORD!" : "FIN";
Â  Â  Â  Â  document.getElementById("over-reason").innerText = lastReason;
Â  Â  Â  Â  document.getElementById("final-stats").innerText = `Distancia: ${score|0}m | Monedas: ${coinsThisRun}`;
Â  Â  }

Â  Â  window.openShop = function() { playSound('click'); hideAll(); updateShopCoinDisplays(); document.getElementById("shop-main").classList.remove("hidden"); }
Â  Â  window.openConcesionario = function() { playSound('click'); hideAll(); updateShopCoinDisplays(); document.getElementById("shop-cars").classList.remove("hidden"); shopIndex = Object.keys(MODELS).indexOf(garage.selected); updateShopUI(); }
Â  Â  window.openMejoras = function() { playSound('click'); hideAll(); updateShopCoinDisplays(); document.getElementById("shop-upgrades").classList.remove("hidden"); updateUI(); }
Â  Â  window.openLogros = function() { playSound('click'); hideAll(); updateShopCoinDisplays(); const cont = document.getElementById("logros-container"); cont.innerHTML = ""; Object.keys(MILESTONES).forEach(key => { let cur = garage.unlockedLogros[key], val = (key === 'totalDist') ? garage.totalDist : (key === 'totalCoins') ? garage.totalCoinsRec : (key === 'totalNear') ? garage.totalNear : garage.totalPlays; const div = document.createElement("div"); div.style.cssText = "background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:10px; border-left: 4px solid var(--weekly-clr);"; div.innerHTML = `<small style="color:var(--weekly-clr); font-weight:800;">${key.toUpperCase()} - NIVEL ${cur}</small><br><b>${cur < 5 ? val.toLocaleString() + ' / ' + MILESTONES[key][cur].toLocaleString() : 'MAX'}</b>`; cont.appendChild(div); }); document.getElementById("shop-logros").classList.remove("hidden"); }
Â  Â  window.openNeones = function() { playSound('click'); hideAll(); updateShopCoinDisplays(); const container = document.getElementById("neon-container"); container.innerHTML = ""; Object.keys(NEONES).forEach(k => { const n = NEONES[k], owned = garage.neonOwned.includes(k), selected = garage.selectedNeon === k, btn = document.createElement("div"); btn.style.cssText = `background:rgba(${n.color[0]},${n.color[1]},${n.color[2]},0.2); padding:10px; border-radius:15px; border: 2px solid ${selected ? '#fff' : 'transparent'}; cursor:pointer; font-size:11px; font-weight:bold;`; btn.innerHTML = `${n.name}<br>${owned ? (selected ? 'EQUIPADO' : 'EQUIPAR') : '$' + n.price.toLocaleString()}`; btn.onclick = () => { playSound('click'); if(owned) { garage.selectedNeon = k; } else if(garage.coins >= n.price) { garage.coins -= n.price; garage.neonOwned.push(k); garage.selectedNeon = k; } save(); openNeones(); }; container.appendChild(btn); }); document.getElementById("shop-neones").classList.remove("hidden"); }
Â  Â Â 
Â  Â  function updateShopUI() { const key = Object.keys(MODELS)[shopIndex], car = MODELS[key]; document.getElementById("shop-car-img").src = `Autos/${car.img}`; document.getElementById("shop-car-name").innerText = car.name; document.getElementById("shop-car-speed").innerText = "VEL: " + (car.maxSpeed * 12).toFixed(0) + " KM/H"; document.getElementById("shop-car-lives").innerText = "â¤ï¸ " + car.lives; const btn = document.getElementById("shop-car-btn"); btn.innerText = garage.owned.includes(key) ? (garage.selected === key ? "EQUIPADO" : "EQUIPAR") : `COMPRAR $${car.price.toLocaleString()}`; btn.onclick = () => { playSound('click'); if(garage.owned.includes(key)) { garage.selected = key; save(); updateShopUI(); } else if(garage.coins >= car.price) { playSound('coin'); garage.coins -= car.price; garage.owned.push(key); garage.selected = key; save(); updateShopUI(); } }; updateShopCoinDisplays(); }
Â  Â  window.nextCar = function() { playSound('click'); shopIndex = (shopIndex + 1) % Object.keys(MODELS).length; updateShopUI(); }
Â  Â  window.prevCar = function() { playSound('click'); shopIndex = (shopIndex - 1 + Object.keys(MODELS).length) % Object.keys(MODELS).length; updateShopUI(); }

Â  Â  window.addEventListener("keydown", e => { if(e.code === "Escape") togglePause(); keys[e.code] = true; }); window.addEventListener("keyup", e => keys[e.code] = false);
Â  Â  const setupT = (id, k) => { const b = document.getElementById(id); b.addEventListener("touchstart", (e) => { e.preventDefault(); keys[k] = true; }); b.addEventListener("touchend", (e) => { e.preventDefault(); keys[k] = false; }); };
Â  Â  setupT("t-left", "ArrowLeft"); setupT("t-right", "ArrowRight"); setupT("t-up", "GAS"); setupT("t-brake", "ArrowDown");

Â  Â  // =================================================================
Â  Â  // ARREGLO FINAL DE PANTALLA DE CARGA Y ACTUALIZACIONES
Â  Â  // =================================================================
Â  Â Â 
Â  Â  // 1. Borrar SW viejo si existe para evitar conflictos
Â  Â  if (window.navigator && navigator.serviceWorker) {
Â  Â  Â  Â  navigator.serviceWorker.getRegistrations().then(function(registrations) {
Â  Â  Â  Â  Â  Â  for(let registration of registrations) {
Â  Â  Â  Â  Â  Â  Â  Â  // Si hay un SW viejo molestando, lo matamos
Â  Â  Â  Â  Â  Â  Â  Â  registration.unregister();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // 2. Registrar el nuevo SW V20
Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  Â  Â  navigator.serviceWorker.register('./sw.js').then(reg => {
Â  Â  Â  Â  Â  Â  Â  Â  console.log('Service Worker v20 registrado limpio');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- DETECCIÃ“N SEGURA DE ACTUALIZACIÃ“N ---
Â  Â  Â  Â  Â  Â  Â  Â  const forceUpdate = (worker) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("ACTUALIZACIÃ“N", "Instalando nueva versiÃ³n...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  worker.postMessage({ type: 'SKIP_WAITING' });
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  if (reg.waiting) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  forceUpdate(reg.waiting);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  reg.onupdatefound = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newWorker = reg.installing;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newWorker.onstatechange = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (newWorker.state === 'installed') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  forceUpdate(newWorker);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }).catch(err => console.log('Error SW:', err));
Â  Â  Â  Â  });

Â  Â  Â  Â  let refreshing = false;
Â  Â  Â  Â  navigator.serviceWorker.addEventListener('controllerchange', () => {
Â  Â  Â  Â  Â  Â  if (!refreshing) {
Â  Â  Â  Â  Â  Â  Â  Â  refreshing = true;
Â  Â  Â  Â  Â  Â  Â  Â  window.location.reload();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // 3. SEGURO DE VIDA: Forzar entrada al menÃº si tarda mÃ¡s de 2.5s
Â  Â  // ESTO ES LO QUE SOLUCIONA QUE SE QUEDE PEGADO EN LA CARGA
Â  Â  setTimeout(() => {
Â  Â  Â  Â  document.getElementById("loading-screen").classList.add("hidden");
Â  Â  Â  Â  showMenu();
Â  Â  }, 2500);

Â  Â  actualizarEstructuraMisiones();
</script>
</body>
</html>

